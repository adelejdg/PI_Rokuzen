<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Agendar Horário</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #e6f5e6; padding: 24px; }
    .container { background: #fff; max-width: 900px; margin: auto; padding: 24px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
    h2 { margin: 0 0 16px 0; color: #1B5E20; }
    .actions { display: flex; gap: 10px; margin-bottom: 16px; }
    button, .btn { padding: 10px 14px; border-radius: 8px; border: none; cursor: pointer; background: #d6edc2; font-weight: 600; }
    button:hover, .btn:hover { background: #c3e6ac; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #cfe6c5; padding: 10px; text-align: center; }
    th { background: #f4fbef; color: #2e7d32; }
    td.slot { cursor: pointer; }
    td.slot.selected { background: #e0f2f1; }
    /* status aleatórios */
    td.slot.status-green { background: #a5d6a7; }
    td.slot.status-red { background: #ef9a9a; }
    th.selectable { cursor: pointer; }
    th.selectable.selected { background: #c5e1a5; }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const table = document.getElementById('grade');
      let selectedName = null;
      table.addEventListener('click', function (e) {
        const head = e.target.closest('th.selectable');
        if (head) {
          table.querySelectorAll('th.selectable.selected').forEach(th => th.classList.remove('selected'));
          head.classList.add('selected');
          selectedName = head.textContent;
          return;
        }
        const cell = e.target.closest('.slot');
        if (!cell) return;
        if (cell.classList.contains('status-red')) return; // não permite selecionar reservados
        table.querySelectorAll('.slot.selected').forEach(td => td.classList.remove('selected'));
        cell.classList.add('selected');
      });

      document.getElementById('btn-confirmar').addEventListener('click', function () {
        const chosen = table.querySelector('.slot.selected');
        if (!selectedName) { alert('Selecione um nome no cabeçalho.'); return; }
        if (!chosen) { alert('Selecione um horário.'); return; }
        const params = new URLSearchParams({ nome: selectedName, horario: chosen.dataset.hora });
        window.location.href = '05_servicos.html?' + params.toString();
      });

      // Substitui os nomes por aleatórios, mas persistindo entre visitas
      const nomesBase = ['Ana', 'Bruno', 'Carla', 'Diego', 'Eduarda', 'Felipe', 'Giovana', 'Hugo', 'Isabela', 'João', 'Katia', 'Leonardo', 'Marina', 'Nicolas', 'Olivia', 'Paula', 'Rafael', 'Sofia', 'Tiago', 'Vitória'];
      const ths = Array.from(table.tHead.querySelectorAll('th')).slice(1);
      let nomesPersistidos = null;
      try { nomesPersistidos = JSON.parse(localStorage.getItem('rokuzen_schedule_names') || 'null'); } catch {}
      if (!nomesPersistidos || nomesPersistidos.length < ths.length) {
        const usados = new Set();
        nomesPersistidos = ths.map(() => {
          let nome;
          do { nome = nomesBase[Math.floor(Math.random() * nomesBase.length)]; } while (usados.has(nome));
          usados.add(nome);
          return nome;
        });
        localStorage.setItem('rokuzen_schedule_names', JSON.stringify(nomesPersistidos));
      }
      ths.forEach((th, i) => {
        th.textContent = nomesPersistidos[i];
        th.classList.add('selectable');
      });

      // Gera horários aleatórios nas células e aplica status
      // horários fixos por linha, sem aleatoriedade
      function horaDaLinha(rowIndex) {
        const mapa = {
          0: '09:00',
          1: '10:00',
          2: '11:00',
          3: '14:00',
          4: '15:00',
          5: '16:00'
        };
        return mapa[rowIndex] || '09:00';
      }

      // Preenche horários fixos por linha
      Array.from(table.tBodies[0].rows).forEach((row, rIdx) => {
        const hora = horaDaLinha(rIdx);
        Array.from(row.cells).forEach((cell, cIdx) => {
          if (cIdx === 0) return; // cabeçalho da linha
          const td = cell;
          if (!td.classList.contains('slot')) return;
          td.textContent = hora;
          td.dataset.hora = hora;
          td.classList.add('status-green');
        });
      });

      // Marcar horários já reservados como indisponíveis (status-red)
      let bookings = [];
      try { bookings = JSON.parse(localStorage.getItem('rokuzen_bookings') || '[]'); } catch {}
      // Mapear nome por coluna
      const headerCols = Array.from(table.tHead.querySelectorAll('th')).slice(1);
      const colToName = headerCols.map(th => th.textContent);
      // Itera linhas e colunas para cruzar com reservas
      Array.from(table.tBodies[0].rows).forEach(row => {
        Array.from(row.cells).forEach((cell, idx) => {
          // idx 0 é o header da linha (hora fixa), colunas começam em 1
          if (idx === 0) return;
          const td = cell;
          if (!td.classList.contains('slot')) return;
          const nomeCol = colToName[idx - 1];
          const horaCell = td.dataset.hora;
          const reservado = bookings.some(b => b.nome === nomeCol && b.horario === horaCell);
          if (reservado) {
            td.classList.remove('selected');
            td.classList.remove('status-green');
            td.classList.add('status-red');
            td.title = 'Horário indisponível';
          } else {
            td.classList.add('status-green');
            td.classList.remove('status-red');
            td.title = 'Disponível';
          }
        });
      });
    });
  </script>
</head>
<body>
<!-- vlibras -->
  <div vw class="enabled">
          <div vw-access-button class="active"></div>
          <div vw-plugin-wrapper>
                    <div class="vw-plugin-top-wrapper"></div>
          </div>
  </div>
  <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
  <script>
  new window.VLibras.Widget('https://vlibras.gov.br/app');
  </script>
  
  <div class="container">
    <h2>Selecione um horário</h2>
    <div class="actions">
      <a class="btn" href="03_meusagendamentos.html">Voltar</a>
      <button id="btn-confirmar">Confirmar seleção</button>
    </div>
    <table id="grade" aria-label="Grade Horária">
      <thead>
        <tr>
          <th>Hora</th>
          <th>Seg</th>
          <th>Ter</th>
          <th>Qua</th>
          <th>Qui</th>
          <th>Sex</th>
          <th>Sáb</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>09:00</th>
          <td class="slot" data-dia="Seg" data-hora="09:00"></td>
          <td class="slot" data-dia="Ter" data-hora="09:00"></td>
          <td class="slot" data-dia="Qua" data-hora="09:00"></td>
          <td class="slot" data-dia="Qui" data-hora="09:00"></td>
          <td class="slot" data-dia="Sex" data-hora="09:00"></td>
          <td class="slot" data-dia="Sáb" data-hora="09:00"></td>
        </tr>
        <tr>
          <th>10:00</th>
          <td class="slot" data-dia="Seg" data-hora="10:00"></td>
          <td class="slot" data-dia="Ter" data-hora="10:00"></td>
          <td class="slot" data-dia="Qua" data-hora="10:00"></td>
          <td class="slot" data-dia="Qui" data-hora="10:00"></td>
          <td class="slot" data-dia="Sex" data-hora="10:00"></td>
          <td class="slot" data-dia="Sáb" data-hora="10:00"></td>
        </tr>
        <tr>
          <th>11:00</th>
          <td class="slot" data-dia="Seg" data-hora="11:00"></td>
          <td class="slot" data-dia="Ter" data-hora="11:00"></td>
          <td class="slot" data-dia="Qua" data-hora="11:00"></td>
          <td class="slot" data-dia="Qui" data-hora="11:00"></td>
          <td class="slot" data-dia="Sex" data-hora="11:00"></td>
          <td class="slot" data-dia="Sáb" data-hora="11:00"></td>
        </tr>
        <tr>
          <th>14:00</th>
          <td class="slot" data-dia="Seg" data-hora="14:00"></td>
          <td class="slot" data-dia="Ter" data-hora="14:00"></td>
          <td class="slot" data-dia="Qua" data-hora="14:00"></td>
          <td class="slot" data-dia="Qui" data-hora="14:00"></td>
          <td class="slot" data-dia="Sex" data-hora="14:00"></td>
          <td class="slot" data-dia="Sáb" data-hora="14:00"></td>
        </tr>
        <tr>
          <th>15:00</th>
          <td class="slot" data-dia="Seg" data-hora="15:00"></td>
          <td class="slot" data-dia="Ter" data-hora="15:00"></td>
          <td class="slot" data-dia="Qua" data-hora="15:00"></td>
          <td class="slot" data-dia="Qui" data-hora="15:00"></td>
          <td class="slot" data-dia="Sex" data-hora="15:00"></td>
          <td class="slot" data-dia="Sáb" data-hora="15:00"></td>
        </tr>
        <tr>
          <th>16:00</th>
          <td class="slot" data-dia="Seg" data-hora="16:00"></td>
          <td class="slot" data-dia="Ter" data-hora="16:00"></td>
          <td class="slot" data-dia="Qua" data-hora="16:00"></td>
          <td class="slot" data-dia="Qui" data-hora="16:00"></td>
          <td class="slot" data-dia="Sex" data-hora="16:00"></td>
          <td class="slot" data-dia="Sáb" data-hora="16:00"></td>
        </tr>
      </tbody>
    </table>
  </div>
</body>
</html>


