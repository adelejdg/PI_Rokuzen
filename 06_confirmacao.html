<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Confirmação do Agendamento</title>
  <style>
    body { font-family: Arial, sans-serif; background: #e6f5e6; padding: 24px; }
    .container { background: #fff; max-width: 800px; margin: auto; padding: 24px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
    h2 { color: #1B5E20; margin: 0 0 16px 0; }
    .row { margin: 8px 0; }
    .actions { margin-top: 16px; display: flex; gap: 10px; }
    .btn { padding: 10px 14px; border-radius: 8px; text-decoration: none; display: inline-block; }
    .btn-primary { background: #8BC34A; color: #fff; }
    .btn-secondary { background: #d6edc2; color: #1B5E20; }
    pre { background: #f6f8fa; padding: 12px; border-radius: 8px; overflow: auto; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Configuração do EmailJS (preencha com seus dados)
      const EMAILJS = {
        serviceId: 'SEU_SERVICE_ID',
        templateId: 'SEU_TEMPLATE_ID',
        publicKey: 'SEU_PUBLIC_KEY'
      };
      if (window.emailjs && EMAILJS.publicKey && EMAILJS.publicKey !== 'SEU_PUBLIC_KEY') {
        emailjs.init(EMAILJS.publicKey);
      }

      const raw = localStorage.getItem('rokuzen_last_booking');
      if (!raw) { document.getElementById('content').textContent = 'Nenhum agendamento encontrado.'; return; }
      const data = JSON.parse(raw);
      const resumo = `Profissional: ${data.nome}\nHorário: ${data.horario}\nServiço: ${data.servico}\nEquipamento: ${data.equipamento}\nDuração avulsa: ${data.duracaoAvulso}\nPacote 4: ${data.pacote4 || '—'}\nPacote 8: ${data.pacote8 || '—'}\nQuando: ${new Date(data.timestamp).toLocaleString()}`;
      document.getElementById('resumo').textContent = resumo;

      // Se houver usuário logado, usar e-mail; senão, pedir ao usuário
      const userRaw = localStorage.getItem('rokuzen_current_user');
      const email = userRaw ? (JSON.parse(userRaw).email || '') : '';
      const assunto = 'Confirmação de Agendamento - Rokuzen';
      const corpo = encodeURIComponent(resumo);
      const mailHref = `mailto:${encodeURIComponent(email)}?subject=${encodeURIComponent(assunto)}&body=${corpo}`;
      document.getElementById('mailto').setAttribute('href', mailHref);

      // Concluir reserva: grava em rokuzen_bookings e redireciona para a grade
      document.getElementById('btn-concluir').addEventListener('click', function () {
        try {
          const list = JSON.parse(localStorage.getItem('rokuzen_bookings') || '[]');
          const exists = list.some(b => b.nome === data.nome && b.horario === data.horario);
          if (!exists) {
            list.push({ nome: data.nome, horario: data.horario, servico: data.servico });
            localStorage.setItem('rokuzen_bookings', JSON.stringify(list));
          }
        } catch {}
        window.location.href = '04_agendar.html';
      });

      // Envio via EmailJS
      const btnEmailjs = document.getElementById('send-emailjs');
      btnEmailjs.addEventListener('click', async function () {
        try {
          if (!window.emailjs || EMAILJS.publicKey === 'SEU_PUBLIC_KEY') {
            alert('Configure o EmailJS (serviceId, templateId, publicKey) no código antes de enviar.');
            return;
          }
          const userRaw = localStorage.getItem('rokuzen_current_user');
          let toEmail = userRaw ? (JSON.parse(userRaw).email || '') : '';
          if (!toEmail) {
            toEmail = prompt('Informe seu e-mail para receber a confirmação:') || '';
          }
          if (!toEmail) { alert('E-mail não informado.'); return; }

          const params = {
            to_email: toEmail,
            subject: assunto,
            message: resumo,
            nome: data.nome,
            horario: data.horario,
            servico: data.servico,
            equipamento: data.equipamento,
            duracao_avulso: data.duracaoAvulso,
            pacote4: data.pacote4 || '—',
            pacote8: data.pacote8 || '—'
          };
          await emailjs.send(EMAILJS.serviceId, EMAILJS.templateId, params);
          alert('E-mail enviado com sucesso!');
        } catch (err) {
          console.error(err);
          alert('Falha ao enviar e-mail. Verifique a configuração do EmailJS.');
        }
      });
    });
  </script>
</head>
<body>
  <div class="container" id="content">
    <h2>Confirmação do Agendamento</h2>
    <div class="row">Confira abaixo os detalhes do seu pedido:</div>
    <pre id="resumo"></pre>
    <div class="actions">
      <button id="btn-concluir" class="btn btn-primary" type="button">Concluir reserva</button>
      <button id="send-emailjs" class="btn btn-primary" type="button">Enviar via EmailJS</button>
      <a id="mailto" class="btn btn-primary" href="#">Enviar por e-mail</a>
      <a class="btn btn-secondary" href="05_servicos.html">Voltar</a>
      <a class="btn btn-secondary" href="01_index.html">Página inicial</a>
    </div>
  </div>
</body>
</html>


